<p align="center">
 <h1 align="center">Dataflow</h1>
 <p align="center">ä¸€ä¸ªæµå¼æ•°æ®çš„é©±åŠ¨ä¸­é—´ä»¶</p>
</p>

<p align="center">
    <a href="https://github.com/anuraghazra/github-readme-stats/graphs/contributors"><img alt="C" src="https://img.shields.io/badge/C-00599C.svg?logo=c&logoColor=white" /></a>
    <a href="https://www.gnu.org/licenses/gpl-3.0.en.html"><img alt="Static Badge" src="https://img.shields.io/badge/license%20-%20GPL%203.0%20-%20blue" /></a>
</p>

<p align="center">
    <a href="https://wiki.yono233.cn/Dataflow/zh_hans/">æ–‡æ¡£</a>
</p>

<p align="center">
    <a href="/README.md">ç®€ä½“ä¸­æ–‡</a>
    Â·
    <a href="/Example/README.DATA/README_EN.md">English</a>
</p>

# ğŸ’‰ä½œç”¨
æœŸæœ›å¸®åŠ©é‚£äº›ç®¡ç†ä¸å¥½ä»¥ä¸‹ä¸¤é¡¹çš„å°ç™½ï¼Œç¬¦åˆä»»ä½•ä¸€é¡¹éƒ½å¯ä»¥ä½¿ç”¨æœ¬åº“è§£å†³ã€‚

>ä¼ è¾“æµçš„ DMAã€‚
>
>ä¼ è¾“æµçš„åŠåŒå·¥ç”¨æ³•ã€‚

æˆ‘ç›¸ä¿¡ä¸ä½¿ç”¨ DMA ä¸”å·¥ä½œåœ¨å…¨åŒå·¥é€šé“ï¼Œä»»ä½•äººéƒ½èƒ½ç®€å•ç¼–å†™è¿è¡Œè‰¯å¥½çš„é©±åŠ¨ã€‚æ‰€ä»¥æœ¬åº“ä¸å»ºè®®åœ¨è¿™ç§åœºæ™¯ä½¿ç”¨ï¼Œæœªæ¥ä¹Ÿä¸ä¼šå¢åŠ é…ç½®é¡¹ä»¥è£å‰ªé€‚åˆè¿™ç§åœºæ™¯ã€‚

**å¦‚æœä½ æ˜¯é«˜æ‰‹ï¼Œè¯·ä¸è¦ä½¿ç”¨ã€‚**

ä¸€ä¸ªå…¸å‹çš„åº”ç”¨åœºæ™¯æ˜¯ï¼Œä¸²å£çš„ RS485 é€šä¿¡ã€‚

# ğŸ©¼å‰¯ä½œç”¨
>**å»¶è¿Ÿ**: ä¼šå¸¦æ¥æ”¶å‘æ•°æ® 1~2ms çš„é¢å¤–å»¶è¿Ÿï¼Œä¸»è¦æ˜¯ç¡®ä¿åˆ‡æ¢åŠåŒå·¥æ–¹å‘çš„ç¨³å®šæ€§ã€‚
>
>**èµ„æº**: ä¼šåŠ å€ RAM ç©ºé—´çš„æ¶ˆè€—ã€‚

å¯¹äºå°ç™½è€Œè¨€ï¼Œè¿™ä¸ç®—ä»€ä¹ˆã€‚

# ğŸ§ºæ€è€ƒæ–¹å‘

æˆ–è€…ä»…å‚è€ƒæ€è·¯æ¥ä¼˜åŒ–è‡ªå·±çš„ç¨‹åºã€‚æœ¬åº“ä»…æ˜¯ä»¥ä¸‹æ€è·¯çš„ä¸€ä¸ªå®è·µï¼Œæˆ–è®¸å¸¦æœ‰ä½œè€…çš„ä¸ªäººåè§ã€‚

### DMA çš„é—®é¢˜
DMA æ¥æ”¶æ˜¯éå¸¸ç®€å•ä¸”æ˜“ç”¨çš„ï¼Œä½†æ˜¯å‘é€çš„è®¾è®¡å´æ¯”è¾ƒå¤æ‚ï¼Œå› ä¸ºåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå‘é€æ•°æ®çš„æ¥æºé€šå¸¸æ˜¯æ‚ä¹±çš„ï¼Œåœ¨ç¨‹åºå„ä¸ªéƒ¨åˆ†éƒ½å¯èƒ½è°ƒç”¨å‘é€APIã€‚

è€Œè°ƒç”¨æ—¶å‘é€ DMA é€šé“è¿˜æ²¡æœ‰ç»“æŸï¼Œå°±ä¼šæ¯”è¾ƒå°´å°¬ã€‚å¤§å¤šæ•°èœé¸Ÿçš„ç”¨æ³•æ˜¯é˜»å¡ç­‰å¾…ï¼Œé‚£å°±å®Œå…¨ä¸§å¤± DMA çš„ä¼˜è¶Šæ€§äº†ã€‚

æˆ‘æ—©æœŸçš„åšæ³•æ˜¯ï¼Œé‡‡ç”¨ä¸€ä¸ªç¯å½¢ buffer æ¥ç¼“å­˜å‘é€æ•°æ®ï¼Œå¹¶å®šæœŸå°†å…¶æ¬è¿åˆ°ä¸€ä¸ªçº¿æ€§ buffer æ¥å¼€å¯å‘é€ DMA(çœç•¥å…·ä½“æ¡ä»¶)ï¼Œè¿™æ ·å½“ç„¶æ˜¯éå¸¸ç¨³å¥çš„ã€‚

å¦‚æœæœ‰è¿‡ä½¿ç”¨ DMA æ¥æ”¶é‡‡æ ·æ•°æ®å¹¶ç»Ÿä¸€å¤„ç†çš„å®è·µç»éªŒï¼Œä¼šäº†è§£åˆ° AB buffer çš„ç”¨æ³•ã€‚æœ‰ AB ä¸¤ä¸ªbufferï¼ŒåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªä¼šæ¥æ”¶æ•°æ®ï¼Œè€Œå¦ä¸€ä¸ªæ­¤æ—¶è£…æ»¡äº†æ•°æ®ï¼Œå¯ä»¥è¿›è¡Œç»Ÿä¸€çš„å¤„ç†ã€‚è¿™å°†ä¼šæ¯”ç¯å½¢ buffer èŠ‚çœè®¸å¤šæ¬è¿ã€‚

æˆ–è®¸æ›´å¤šäººå«ä¹’ä¹“ bufferï¼Œæˆ‘åªæ˜¯ä¸å–œæ¬¢è¿™ä¸ªå«æ³•ã€‚

å¦å¤–å¦‚æœæ˜¯å¸¦æœ‰ D-Cache çš„ MCU éœ€è¦ç‰¹åˆ«æ³¨æ„ç¼“å­˜ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œå¶å°”å¯èƒ½éœ€è¦è‡ªå·±è§£å†³ä¸€ä¸‹ï¼Œå¯ä»¥å‚è€ƒä¾‹ç¨‹ä¸­çš„æ–¹æ³•ã€‚æœ¬åº“å·²ç»å°½é‡ä½¿ç”¨ volatile è¿›è¡Œä¿®é¥°ï¼Œä½†æ˜¯ hal åº“å¯¹äº DMA ä»¥åŠ Cache ä»ç„¶æ²¡æœ‰å¾ˆå¥½çš„å¤„ç†ã€‚

é‚£ä¹ˆå‘é€æ˜¯å¦ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™æ ·çš„åšæ³•å‘¢ï¼Ÿåæ­£åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ª buffer æŒ‚åœ¨ DMA é€šé“ä¸Šã€‚

### åŠåŒå·¥çš„é—®é¢˜
é€šå¸¸åŠåŒå·¥é€šé“éœ€è¦**æ•°åçº³ç§’**åˆ°**æ•°å¾®ç§’**åˆ‡æ¢æ”¶å‘æ–¹å‘ï¼Œ1æ¯«ç§’çš„å»¶è¿Ÿæ˜¯å¿…ç„¶ç¨³å¥çš„ã€‚

åŠåŒå·¥çš„é€šä¿¡ä¸ DMA å…¶å®æ˜¯æœ‰ç›¸ä¼¼æ€§çš„ï¼Œéƒ½éœ€è¦å°†æ‚ä¹±è€Œæ¥çš„æ•°æ®é›†åˆèµ·æ¥ï¼Œå»ºç«‹ä¸€æ®µé€šé“ç»Ÿä¸€è¿›è¡Œä¼ è¾“ã€‚æ‰€ä»¥å°†é€šä¿¡åˆ†ä¸¤æ­¥è¿›è¡Œæ˜¯åˆé€‚çš„ã€‚

è€Œæˆ‘è®¤ä¸ºä½¿ç”¨åŠåŒå·¥çš„åœºæ™¯ã€‚å¯¹äºé€šä¿¡å»¶è¿Ÿæˆ–è®¸å°±ä¸åœ¨æ„äº†ï¼Œé‡è¦çš„æ˜¯ç¨³å¥å¯é çš„ä¿¡æ¯ã€‚ä¾‹å¦‚æˆ‘ä½¿ç”¨çš„ AMD2587 IC å‘é€æœºåˆ‡æ¢éœ€è¦ 2.5 Î¼sï¼Œä¸”åœ¨è·‘ modbusRTU ï¼Œè¿™ç§ä½¿ç”¨åœºæ™¯ä¸‹ä½¿ç”¨å®šæ—¶å™¨è¿›è¡Œç»å¯¹çš„ç”µå¹³æ§åˆ¶æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œæ‰€ä»¥æœ¬åº“å°†å»ºç«‹ä¸€ä¸ªæ”¶å‘æ•°æ® 1ms å»¶è¿Ÿåˆ‡æ¢çš„æœºåˆ¶ã€‚

# ğŸ¤”å¦‚ä½•ä½¿ç”¨

å»ºè®®ç›´æ¥å‚è€ƒ [åœ¨stm32çš„ç¤ºä¾‹](/Example/stm32H743/h7_main.c)

é¦–å…ˆç»™åº“çš„å¯¹è±¡å˜é‡é¢„åˆ†é…è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ã€‚æ³¨æ„ï¼Œè¿™ä¸ªå†…å­˜ç©ºé—´æä¾›ç»™å‘é€ä»¥åŠæ¥æ”¶ï¼Œè€Œä¸”éœ€è¦åŒä»½ã€‚

```c
// å»ºè®®4å­—èŠ‚å¯¹é½ï¼Œå¦åˆ™ DMA å¯èƒ½å­˜åœ¨é—®é¢˜
#define T_LEN_MAX 256
#define R_LEN_MAX 256
/* é¢„åˆ†é…å†…å­˜åŒº */
uint8_t MEM[T_LEN_MAX * 2 + R_LEN_MAX * 2] __ALIGNED(32);
```

åˆ›å»ºåº“å¯¹è±¡å˜é‡ï¼Œä»¥åŠå…¶ä½¿ç”¨çš„å›è°ƒç»‘å®šå˜é‡ã€‚åœ¨è¿™é‡Œï¼Œå¦‚æœ .SendBefor ä»¥åŠ .SendOver ç»‘å®šä¸º **NULL** ï¼Œé‚£ä¹ˆå°†æ²¡æœ‰åŠåŒå·¥é€šé“åˆ‡æ¢çš„æ”¯æŒï¼Œæ²¡æœ‰å»¶è¿ŸçŠ¶æ€æœºçš„åˆ¤æ–­ï¼Œä»…æœ‰ DMA çš„é€»è¾‘ï¼Œä¹Ÿä¼šç¨å¾®å¢å¼ºæ€§èƒ½ã€‚

```c
/* Dataflowå¯¹è±¡*/
_DFlow                  DFlow;
_DFLOW_COMMON_FUNCTION  DFlowFunc = {
    .Transmit         = Transmit485, 
    .Receive          = Receive485,
    .TransmitGetState = TransmitGetState485,
    .SendBefor        = SendBefor485,
    .SendOver         = SendOver485};
```

ç¨‹åºä¸­è¿›è¡Œå¯¹è±¡çš„åˆå§‹åŒ–

```c
    DFlow_Init(&DFlow, MEM, T_LEN_MAX, R_LEN_MAX, &DFlowFunc);
```

å‘¨æœŸæ€§åœ°è°ƒç”¨åº“ tick ï¼Œé’ˆå¯¹æŸä¸ªå¯¹è±¡ï¼Œå¦‚æœæœ‰å¤šä¸ªå¯¹è±¡è¯·ä¸€ä¸€è°ƒç”¨ã€‚

```c
while(1)
{
    DFlow_Ticks(&DFlow);
    HAL_Delay(1);
}
```
åœ¨åˆé€‚çš„ä¸­æ–­å¤„ç†ï¼Œå¼•å‘åˆé€‚çš„åº“å¤„ç†ã€‚è¯¦è§ç¤ºä¾‹ã€‚

>**å‘é€ç»“æŸä¸­æ–­**:  DFlow_Interrupt_TC(&DFlow);
>
>**ç©ºé—²ä¸­æ–­ & æ¥æ”¶ç»“æŸä¸­æ–­ &åŸæ•™æ—¨DMA FTFä¸­æ–­(éhal)**: DFlow_Interrupt_IDLE_RC_FTF(&DFlow, Size);

ç„¶åå°±å¯ä»¥åœ¨ç¨‹åºä»»ä½•åœ°æ–¹éšæ„åœ°è°ƒç”¨å‘é€å’Œæ¥æ”¶å•¦

```c
//å‘é€
DFlow_Write(&DFlow, "Hello3\n", sizeof("Hello3\n"));
//æ¥æ”¶
while(DFlow_Getc(&DFlow, &data) == DFLOW_API_RETURN_DEFAULT)
{

}
```



# å„è®¾è®¡

bufferæ¨¡å‹

![](https://cloudflare-imgbed-6qt.pages.dev/file/1735001474791_buffer%20%E6%A8%A1%E5%9E%8B.png)

ä¸­æ–­å¤„ç†

![](https://cloudflare-imgbed-6qt.pages.dev/file/1735001486438_%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86.png)

è½®è¯¢å¤„ç†

![](https://cloudflare-imgbed-6qt.pages.dev/file/1735001486588_%E8%BD%AE%E8%AF%A2%E5%A4%84%E7%90%86.png)

